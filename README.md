# Docker-окружение для сервера 1С:Предприятие

Этот проект предоставляет готовое решение для быстрого развертывания сервера 1С:Предприятие и PostgreSQL в изолированных Docker-контейнерах.

## Основные возможности

* Локальная сборка Docker-образа сервера 1С с необходимой версией платформы.
* Использование Docker Compose для простого управления сервисами (запуск, остановка).
* Сохранение данных PostgreSQL и настроек кластера 1С между перезапусками контейнеров.

## Структура проекта

```text
.
├── 1c-server/              # Все для сборки образа сервера 1С
│   ├── distr/              # Сюда нужно положить .deb дистрибутивы 1С (папка игнорируется Git)
│   ├── Dockerfile          # Инструкция по сборке образа 1С
│   └── start.sh            # Скрипт запуска служб 1С внутри контейнера
├── .gitignore              # Исключает файлы дистрибутивов из репозитория
└── docker-compose.yml      # Главный файл для оркестровки контейнеров
```

## Как использовать

### Предварительные требования

* Установленный [Docker](https://www.docker.com/get-started)
* Установленный [Docker Compose](https://docs.docker.com/compose/install/)

---

### Шаг 1: Сборка и публикация версионированного образа

Этот процесс выполняется на вашем локальном компьютере.

1. **Клонируйте репозиторий:**

    ```bash
    git clone https://github.com/defin85/1c-docker.git
    cd 1c-docker
    ```

2. **Поместите дистрибутивы 1С:**
    Скопируйте необходимые `.deb` файлы дистрибутива сервера 1С для Linux в папку `1c-server/distr/`.

3. **Авторизуйтесь в Docker Hub:**
    Чтобы публиковать образы в ваш репозиторий (`defin85/1c-server`), вам необходимо представиться системе Docker Hub. Это нужно сделать **один раз** на каждом компьютере, с которого вы планируете публиковать образы.

    Выполните команду:

    ```bash
    docker login
    ```

    Система запросит у вас логин и пароль.
    * **Username:** `defin85`
    * **Password:** Вместо вашего обычного пароля от Docker Hub **настоятельно рекомендуется использовать Access Token (токен доступа)**. Это более безопасный способ.

    **Как создать Access Token:**
    1. Зайдите в ваш аккаунт на [hub.docker.com](https://hub.docker.com).
    2. Перейдите в `Account Settings` -> `Security`.
    3. Нажмите `New Access Token`, дайте ему имя (например, `my-pc-builder`) и назначьте права `Read, Write, Delete`.
    4. Скопируйте сгенерированный токен и используйте его в качестве пароля в командной строке. **Важно:** Docker Hub покажет вам токен только один раз.

    После успешной авторизации Docker сохранит ваши учетные данные, и вам не придется вводить их при каждой публикации.

4. **Соберите и опубликуйте образ:**
    Задайте переменную с версией платформы 1С и выполните команды сборки и публикации.

    ```bash
    # Укажите здесь версию платформы из имен deb-файлов
    export VERSION=8.3.25.1394 
    
    # Собираем образ с тегом версии
    docker build -t defin85/1c-server:$VERSION ./1c-server
    
    # Публикуем образ в Docker Hub
    docker push defin85/1c-server:$VERSION
    ```

    *Для Windows PowerShell команды будут другими:*

    ```powershell
    $env:VERSION="8.3.25.1394"
    docker build -t defin85/1c-server:$env:VERSION ./1c-server
    docker push defin85/1c-server:$env:VERSION
    ```

---

### Шаг 2: Запуск окружения через Docker Compose

После того как вы опубликовали образ в Docker Hub, вы (или ваши коллеги) можете запустить проект.

1. **Настройте `docker-compose.yml`:**
    * Откройте `docker-compose.yml` и укажите нужную версию образа, которую вы собрали на предыдущем шаге.

        ```yaml
        # ...
        1c-server:
          # image: defin85/1c-server:latest # Больше не используется
          image: defin85/1c-server:8.3.25.1394 # <-- Укажите здесь нужную версию
          # ...
        ```

    * **ОБЯЗАТЕЛЬНО** смените пароль для PostgreSQL в переменной `POSTGRES_PASSWORD`.

2. **Запустите контейнеры:**
    Docker автоматически скачает указанный образ из Docker Hub, если его нет локально.

    ```bash
    docker-compose up -d
    ```

### Остановка окружения

Чтобы остановить запущенные контейнеры, выполните:

```bash
docker-compose down
```
